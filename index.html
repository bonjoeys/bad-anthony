<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Bad sur loire</title>
    <!-- NOUVEAU: Ajout noindex, nofollow -->
    <meta name="robots" content="noindex, nofollow">
    <!-- Chargement de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Police Inter (similaire à l'original) */
        body, html {
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            height: 100%;
        }
        /* Classe utilitaire pour cacher les vues et modales */
        .hidden {
            display: none;
        }
        /* Styles pour la scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #a8a8a8;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #888;
        }
        /* Style pour les paires */
        .pair-row + .pair-row {
            border-top: 1px dashed #e5e7eb; /* Ligne pointillée entre les partenaires */
        }
        .pair-row .pair-indicator {
            visibility: hidden; /* Cache l'indicateur par défaut */
        }
        .pair-row:first-child .pair-indicator {
             visibility: visible; /* Affiche l'indicateur pour le premier joueur de la paire */
        }
        /* Style pour la modale simple (liste à cocher) */
        .participant-checkbox-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex h-screen bg-gray-100">
        <!-- Barre latérale de navigation -->
        <nav class="w-64 bg-gray-900 text-white flex flex-col flex-shrink-0">
            <div class="p-4 border-b border-gray-700">
                <h2 class="text-xl font-bold">Mon Bad sur loire</h2>
                <span class="text-sm text-gray-400">Tournoi 2025-26</span>
            </div>
            
            <!-- Navigation principale -->
            <div class="flex-1 p-4 space-y-2">
                <button id="nav-players-btn"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-700 transition-colors duration-150 bg-blue-600">
                    Gérer les Joueurs
                </button>
                <button id="nav-tournaments-btn"
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-700 transition-colors duration-150">
                    Gérer les Tournois
                </button>

                <!-- Liste des tournois créés (vos "onglets") -->
                <div class="pt-4 border-t border-gray-700">
                    <h3 class="px-3 text-sm font-semibold text-gray-400 uppercase tracking-wider">Tableaux</h3>
                    <div id="sidebar-tournaments-list" class="mt-2 space-y-1">
                        <p class="px-3 text-sm text-gray-500">Aucun tableau créé.</p>
                    </div>
                </div>
            </div>
            
            <!-- Statut de la connexion -->
            <div class="p-4 border-t border-gray-700">
                <div id="auth-status-connected" class="">
                    <div class="text-xs text-green-400">Connecté (Local)</div>
                    <div id="auth-status-userid" class="text-xs text-gray-500 break-words">Mode Test</div>
                </div>
                <div id="auth-status-connecting" class="hidden">
                    <div class="text-xs text-yellow-400">Connexion en cours...</div>
                </div>
            </div>
        </nav>

        <!-- Contenu principal -->
        <main class="flex-1 p-8 overflow-y-auto">
            
            <!-- Vue: Gestion des Joueurs ("base des inscris") -->
            <div id="view-players" class="page-view max-w-6xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Gestion des Joueurs</h1>
                    <div class="flex items-center space-x-4">
                        <!-- Champ de recherche -->
                        <div class="flex items-center">
                             <input type="text" id="search-players-input" placeholder="Rechercher (nom, prénom, licence)..."
                                class="px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                        </div>
                        <!-- FIN Champ de recherche -->
                        <div class="flex items-center space-x-2">
                            <label for="sort-players" class="text-sm font-medium text-gray-700">Trier par :</label>
                            <select id="sort-players-select"
                                class="px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                <option value="alpha-asc">Alphabétique (A-Z)</option>
                                <option value="date-desc">Date d'inscription (Plus récents)</option>
                                <option value="date-asc">Date d'inscription (Plus anciens)</option>
                            </select>
                        </div>
                        <button id="show-add-player-modal-btn"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-transform duration-150 active:scale-95">
                            + Nouveau Joueur
                        </button>
                    </div>
                </div>
                <div class="bg-white shadow-xl rounded-lg overflow-hidden">
                    <table class="w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prénom</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date Inscription</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">N° Licence</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Club</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Souhaits</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="players-table-body" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="7" class="px-6 py-12 text-center text-gray-500">Chargement des joueurs...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Vue: Gestion des Tournois (les "onglets") -->
            <div id="view-tournaments" class="page-view hidden max-w-6xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Gestion des Tableaux (Tournois)</h1>
                    <button id="show-add-tournament-modal-btn"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-transform duration-150 active:scale-95">
                        + Nouveau Tableau
                    </button>
                </div>
                <div class="bg-white shadow-xl rounded-lg overflow-hidden">
                    <table class="w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom du Tableau</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nb. Participants</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tournaments-table-body" class="bg-white divide-y divide-gray-200">
                           <tr><td colspan="4" class="px-6 py-12 text-center text-gray-500">Aucun tableau créé.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Vue: Détail d'un Tournoi (participants) -->
            <div id="view-tournament-detail" class="page-view hidden max-w-6xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h1 id="detail-tournament-name" class="text-3xl font-bold text-gray-800"></h1>
                        <p id="detail-tournament-type" class="text-lg text-gray-600 capitalize"></p>
                    </div>
                    <button id="show-add-participant-modal-btn"
                        class="px-4 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition-transform duration-150 active:scale-95 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        + Ajouter un Participant
                    </button>
                </div>
                <div class="bg-white shadow-xl rounded-lg overflow-hidden">
                    <table class="w-full"> <!-- Pas de divide-y ici pour gérer les paires -->
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="w-5 px-6 py-3"></th> <!-- Colonne pour l'icône de paire -->
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prénom</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">N° Licence</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Club</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="participants-table-body" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="6" class="px-6 py-12 text-center text-gray-500">Aucun participant dans ce tableau.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <!-- ===== MODALES ===== -->

    <!-- Modale: Ajout d'un nouveau joueur -->
    <div id="modal-add-player" class="modal-overlay hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="modal-content bg-white p-8 rounded-lg shadow-2xl w-full max-w-md">
            <h3 class="text-2xl font-bold mb-6 text-gray-800">Ajouter un nouveau joueur</h3>
            <form id="form-add-player">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nom</label>
                        <input type="text" id="new-player-lastname" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Prénom</label>
                        <input type="text" id="new-player-firstname" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date d'inscription</label>
                        <input type="date" id="new-player-regdate" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">N° Licence</label>
                        <input type="text" id="new-player-license" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Club</label>
                        <input type="text" id="new-player-club" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <!-- Cases à cocher Souhaits -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Souhaits d'inscription</label>
                        <div class="flex items-center space-x-4 pt-1">
                            <label class="flex items-center text-sm text-gray-700">
                                <input type="checkbox" id="new-player-wishes-simple" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mr-2">
                                Simple
                            </label>
                            <label class="flex items-center text-sm text-gray-700">
                                <input type="checkbox" id="new-player-wishes-double" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mr-2">
                                Double
                            </label>
                            <label class="flex items-center text-sm text-gray-700">
                                <input type="checkbox" id="new-player-wishes-mixte" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mr-2">
                                Mixte
                            </label>
                        </div>
                    </div>
                    <!-- FIN Cases à cocher -->
                </div>
                <div class="mt-8 flex justify-end space-x-3">
                    <button type="button" class="modal-cancel-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Annuler</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modale: Ajout d'un nouveau tournoi ("onglet") -->
    <div id="modal-add-tournament" class="modal-overlay hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="modal-content bg-white p-8 rounded-lg shadow-2xl w-full max-w-md">
            <h3 class="text-2xl font-bold mb-6 text-gray-800">Créer un nouveau tableau</h3>
            <form id="form-add-tournament">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nom du tableau</label>
                        <input type="text" id="new-tournament-name" placeholder="Ex: Simple Homme R" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Type de tableau</label>
                        <select id="new-tournament-type" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="simple">Simple</option>
                            <option value="double">Double</option>
                            <option value="mixte">Mixte</option>
                        </select>
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-3">
                    <button type="button" class="modal-cancel-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Annuler</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Créer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modale: Ajout d'un participant (SIMPLE) - OPTIMISÉE -->
    <div id="modal-add-participant-simple" class="modal-overlay hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="modal-content bg-white p-8 rounded-lg shadow-2xl w-full max-w-md">
            <h3 class="text-2xl font-bold mb-6 text-gray-800">Ajouter des participants (Simple)</h3>
            <p class="text-sm text-gray-600 mb-4">
                Cochez les joueurs à ajouter à <strong id="modal-participant-simple-tournament-name"></strong>.
            </p>
            <form id="form-add-participant-simple">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Joueurs disponibles</label>
                        <div id="participant-checkbox-list" class="participant-checkbox-list space-y-2">
                            <!-- Les joueurs seront injectés ici par JS -->
                            <p class="text-sm text-gray-500 p-4 text-center">Aucun joueur disponible.</p>
                        </div>
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-3">
                    <button type="button" class="modal-cancel-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Fermer</button>
                    <button type="submit" id="add-participant-simple-submit-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400">Ajouter les sélectionnés</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modale: Ajout d'une PAIRE (Double / Mixte) - OPTIMISÉE -->
    <div id="modal-add-participant-pair" class="modal-overlay hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="modal-content bg-white p-8 rounded-lg shadow-2xl w-full max-w-md">
            <h3 class="text-2xl font-bold mb-6 text-gray-800">Ajouter des Paires</h3>
            <p class="text-sm text-gray-600 mb-4">
                Inscrivez les paires pour <strong id="modal-participant-pair-tournament-name"></strong>.
            </p>
            <form id="form-add-participant-pair">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Joueur 1</label>
                        <select id="select-pair-player1" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="" disabled selected>Sélectionner le joueur 1...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Joueur 2</label>
                        <select id="select-pair-player2" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="" disabled selected>Sélectionner le joueur 2...</option>
                        </select>
                    </div>
                     <p id="pair-warning" class="text-sm text-red-600 hidden">Veuillez sélectionner deux joueurs différents.</p>
                     <p id="pair-added-success" class="text-sm text-green-600 hidden">Paire ajoutée !</p>
                </div>
                <div class="mt-8 flex justify-between space-x-3">
                    <button type="button" class="modal-cancel-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Fermer</Lbutton>
                    <button type="submit" id="add-participant-pair-submit-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400">Ajouter et Suivant</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Modale: Modifier un joueur -->
    <div id="modal-edit-player" class="modal-overlay hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="modal-content bg-white p-8 rounded-lg shadow-2xl w-full max-w-md">
            <h3 class="text-2xl font-bold mb-6 text-gray-800">Modifier le joueur</h3>
            <form id="form-edit-player">
                <!-- Champ caché pour stocker l'ID du joueur en cours de modification -->
                <input type="hidden" id="edit-player-id">
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nom</label>
                        <input type="text" id="edit-player-lastname" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Prénom</label>
                        <input type="text" id="edit-player-firstname" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date d'inscription</label>
                        <input type="date" id="edit-player-regdate" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">N° Licence</label>
                        <input type="text" id="edit-player-license" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Club</label>
                        <input type="text" id="edit-player-club" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <!-- Cases à cocher Souhaits -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Souhaits d'inscription</label>
                        <div class="flex items-center space-x-4 pt-1">
                            <label class="flex items-center text-sm text-gray-700">
                                <input type="checkbox" id="edit-player-wishes-simple" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mr-2">
                                Simple
                            </label>
                            <label class="flex items-center text-sm text-gray-700">
                                <input type="checkbox" id="edit-player-wishes-double" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mr-2">
                                Double
                            </label>
                            <label class="flex items-center text-sm text-gray-700">
                                <input type="checkbox" id="edit-player-wishes-mixte" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mr-2">
                                Mixte
                            </label>
                        </div>
                    </div>
                    <!-- FIN Cases à cocher -->
                </div>
                <div class="mt-8 flex justify-end space-x-3">
                    <button type="button" class="modal-cancel-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Annuler</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Enregistrer les modifications</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Script principal (LOCAL - SANS FIREBASE) -->
    <script type="module">
        // --- Données d'exemple (notre "base de données" locale) ---
        const SAMPLE_PLAYERS = [
          { lastName: "Martin", firstName: "Vincent", license: "07367979", club: "CEST37", registrationDate: "2025-10-01", wishesSimple: true, wishesDouble: true, wishesMixte: false },
          { lastName: "Loiseau", firstName: "Christophe", license: "07498393", club: "BCE72", registrationDate: "2025-10-02", wishesSimple: false, wishesDouble: true, wishesMixte: false },
          { lastName: "Ravary", firstName: "Corentin", license: "07646991", club: "ASPC49", registrationDate: "2025-10-01", wishesSimple: true, wishesDouble: false, wishesMixte: false },
          { lastName: "Taugourdeau", firstName: "Gwénaelle", license: "06746314", club: "ONEA49", registrationDate: "2025-10-03", wishesSimple: true, wishesDouble: true, wishesMixte: true },
          { lastName: "Charron", firstName: "Alexandre", license: "06499200", club: "ASCEMMA72", registrationDate: "2025-10-02", wishesSimple: true, wishesDouble: true, wishesMixte: false },
          { lastName: "Molle", firstName: "Guillaume", license: "07516153", club: "ASCEMMA72", registrationDate: "2025-10-04", wishesSimple: false, wishesDouble: true, wishesMixte: false },
          { lastName: "Fontenay", firstName: "Maxime", license: "07390128", club: "CEST37", registrationDate: "2025-10-05", wishesSimple: true, wishesDouble: false, wishesMixte: false },
          { lastName: "Mellet", firstName: "Elie", license: "06972886", club: "CEST37", registrationDate: "2025-10-05", wishesSimple: true, wishesDouble: true, wishesMixte: false },
          { lastName: "Chaintron", firstName: "Mylène", license: "06639623", club: "TBSMC72", registrationDate: "2025-10-03", wishesSimple: false, wishesDouble: true, wishesMixte: true },
          { lastName: "Vetu", firstName: "Marine", license: "07519726", club: "JSC72", registrationDate: "2025-10-06", wishesSimple: true, wishesDouble: false, wishesMixte: true },
          { lastName: "Herillard", firstName: "Fabien", license: "00436837", club: "JSC72", registrationDate: "2025-10-07", wishesSimple: true, wishesDouble: true, wishesMixte: false },
          { lastName: "Barge", firstName: "Antony", license: "06522803", club: "IMBC92", registrationDate: "2025-10-07", wishesSimple: false, wishesDouble: true, wishesMixte: false },
          { lastName: "Rosaenz", firstName: "Camille", license: "07562582", club: "JSC72", registrationDate: "2025-10-08", wishesSimple: true, wishesDouble: false, wishesMixte: true },
          { lastName: "Bordeau", firstName: "Quentin", license: "06759420", club: "LPL53", registrationDate: "2025-10-09", wishesSimple: true, wishesDouble: true, wishesMixte: false },
          { lastName: "Bechec", firstName: "Malou", license: "07574178", club: "SCB49", registrationDate: "2025-10-10", wishesSimple: false, wishesDouble: false, wishesMixte: true },
        ];

        // --- État de l'application ---
        let allPlayers = [];
        let allTournaments = []; // Structure: { id, name, type, participants: [] }
        let currentTournament = null;
        let currentSortMode = 'alpha-asc';
        let currentSearchTerm = '';
        let isLoadingPlayers = true;
        let activeView = 'players'; // 'players', 'tournaments', 'tournament-detail'
 
        // --- Références DOM ---
        const views = {
            players: document.getElementById('view-players'),
            tournaments: document.getElementById('view-tournaments'),
            tournamentDetail: document.getElementById('view-tournament-detail'),
        };
        const modals = {
            addPlayer: document.getElementById('modal-add-player'),
            addTournament: document.getElementById('modal-add-tournament'),
            addParticipantSimple: document.getElementById('modal-add-participant-simple'),
            addParticipantPair: document.getElementById('modal-add-participant-pair'),
            editPlayer: document.getElementById('modal-edit-player'),
        };
        const navButtons = {
            players: document.getElementById('nav-players-btn'),
            tournaments: document.getElementById('nav-tournaments-btn'),
        };
        const playersTableBody = document.getElementById('players-table-body');
        const tournamentsTableBody = document.getElementById('tournaments-table-body');
        const sidebarTournamentsList = document.getElementById('sidebar-tournaments-list');
        const participantsTableBody = document.getElementById('participants-table-body');
        
        const detailTournamentName = document.getElementById('detail-tournament-name');
        const detailTournamentType = document.getElementById('detail-tournament-type');
        const sortPlayersSelect = document.getElementById('sort-players-select');
        const searchPlayersInput = document.getElementById('search-players-input');
        
        // Références pour la modale Paire
        const pairPlayer1Select = document.getElementById('select-pair-player1');
        const pairPlayer2Select = document.getElementById('select-pair-player2');
        const pairWarning = document.getElementById('pair-warning');
        const pairAddedSuccess = document.getElementById('pair-added-success'); // Message succès
        
        // Références pour la modale Simple (optimisée)
        const participantCheckboxList = document.getElementById('participant-checkbox-list');
        const addParticipantSimpleSubmitBtn = document.getElementById('add-participant-simple-submit-btn');

        
        // --- Initialisation ---
        document.addEventListener('DOMContentLoaded', () => {
            setupFakeAuth();
            loadInitialData();
            setupEventListeners();
        });

        // --- Authentification (simulée) ---
        function setupFakeAuth() {
            const statusConnected = document.getElementById('auth-status-connected');
            const statusConnecting = document.getElementById('auth-status-connecting');
            
            statusConnected.classList.remove('hidden');
            statusConnecting.classList.add('hidden');
            console.log("Mode local activé. Données en dur.");
        }

        // --- Chargement des données (simulé) ---
        function loadInitialData() {
            isLoadingPlayers = true;
            // On simule une base de données en ajoutant un ID unique à nos données d'exemple
            allPlayers = SAMPLE_PLAYERS.map(player => ({
                ...player,
                id: crypto.randomUUID() // Génère un ID unique
            }));
            
            isLoadingPlayers = false;
            renderPlayers();
            renderTournamentsList();
            renderSidebarTournaments();
        }

        // --- Fonctions de Rendu (Affichage) ---

        function formatDate(isoDate) {
            if (!isoDate) return '';
            const [year, month, day] = isoDate.split('-');
            if (!year || !month || !day) return isoDate; // Retourne la date brute si format inconnu
            return `${day}/${month}/${year}`;
        }

        // Formate les souhaits pour l'affichage
        function formatWishes(player) {
            const wishes = [];
            if (player.wishesSimple) wishes.push('S');
            if (player.wishesDouble) wishes.push('D');
            if (player.wishesMixte) wishes.push('M');
            
            if (wishes.length === 0) return '-';
            return wishes.join(' / ');
        }
        
        // Trouve un joueur par ID (helper)
        function getPlayerById(playerId) {
            return allPlayers.find(p => p.id === playerId);
        }

        function renderPlayers() {
            // Filtrer d'abord
            const filteredPlayers = allPlayers.filter(player => {
                const searchTerm = currentSearchTerm; // Déjà en minuscules
                const fullName = `${player.firstName || ''} ${player.lastName || ''}`.toLowerCase();
                const license = (player.license || '').toLowerCase();
                
                return fullName.includes(searchTerm) || license.includes(searchTerm);
            });

            // Trier la liste filtrée
            const sortedPlayers = [...filteredPlayers];
            
            switch (currentSortMode) {
                case 'alpha-asc':
                    sortedPlayers.sort((a, b) => {
                        const lastNameComparison = a.lastName.localeCompare(b.lastName);
                        if (lastNameComparison !== 0) return lastNameComparison;
                        return a.firstName.localeCompare(b.firstName);
                    });
                    break;
                case 'date-desc':
                    sortedPlayers.sort((a, b) => new Date(b.registrationDate).getTime() - new Date(a.registrationDate).getTime());
                    break;
                case 'date-asc':
                    sortedPlayers.sort((a, b) => new Date(a.registrationDate).getTime() - new Date(b.registrationDate).getTime());
                    break;
            }

            if (sortedPlayers.length === 0 && !isLoadingPlayers) {
                if (currentSearchTerm) { // Message si la recherche ne donne rien
                     playersTableBody.innerHTML = `<tr><td colspan="7" class="px-6 py-12 text-center text-gray-500">Aucun joueur ne correspond à votre recherche.</td></tr>`;
                } else {
                     playersTableBody.innerHTML = `<tr><td colspan="7" class="px-6 py-12 text-center text-gray-500">Aucun joueur dans la base. Cliquez sur "+ Nouveau Joueur" pour commencer.</td></tr>`;
                }
                return;
            }
            if (isLoadingPlayers && sortedPlayers.length === 0) {
                 playersTableBody.innerHTML = `<tr><td colspan="7" class="px-6 py-12 text-center text-gray-500">Chargement des joueurs...</td></tr>`;
                 return;
            }

            playersTableBody.innerHTML = sortedPlayers.map(player => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${player.lastName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${player.firstName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${formatDate(player.registrationDate)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${player.license}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${player.club}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${formatWishes(player)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                        <button data-id="${player.id}" class="btn-edit-player text-indigo-600 hover:text-indigo-900">Modifier</button>
                        <button data-id="${player.id}" class="btn-delete-player text-red-600 hover:text-red-900">Supprimer</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderTournamentsList() {
            if (allTournaments.length === 0) {
                tournamentsTableBody.innerHTML = `<tr><td colspan="4" class="px-6 py-12 text-center text-gray-500">Aucun tableau créé.</td></tr>`;
                return;
            }
            tournamentsTableBody.innerHTML = allTournaments.map(t => {
                // Compte les participants uniques (gère simples et paires)
                const participantCount = t.participants.length; 
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${t.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 capitalize">${t.type}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${participantCount} ${t.type === 'simple' ? 'joueur(s)' : 'paire(s)'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                            <button data-id="${t.id}" class="btn-manage-tournament text-blue-600 hover:text-blue-900">Gérer</button>
                            <button data-id="${t.id}" class="btn-delete-tournament text-red-600 hover:text-red-900">Supprimer</button>
                        </td>
                    </tr>
                `
            }).join('');
        }

        function renderSidebarTournaments() {
            if (allTournaments.length === 0) {
                sidebarTournamentsList.innerHTML = `<p class="px-3 text-sm text-gray-500">Aucun tableau créé.</p>`;
                return;
            }
            sidebarTournamentsList.innerHTML = allTournaments.map(t => `
                <button data-id="${t.id}"
                    class="btn-sidebar-tournament w-full text-left px-3 py-2 rounded-lg hover:bg-gray-600 transition-colors duration-150 truncate">
                    ${t.name}
                </button>
            `).join('');
        }
        
        // Gère l'affichage du tableau des participants (Simple OU Paire)
        function renderTournamentDetail() {
            if (!currentTournament) return;
            
            detailTournamentName.textContent = currentTournament.name;
            detailTournamentType.textContent = currentTournament.type;

            const participants = currentTournament.participants;

            // Rendu tableau participants
            if (participants.length === 0) {
                participantsTableBody.innerHTML = `<tr><td colspan="6" class="px-6 py-12 text-center text-gray-500">Aucun participant dans ce tableau.</td></tr>`;
            } else {
                participantsTableBody.innerHTML = ''; // Vider le tableau
                
                if (currentTournament.type === 'simple') {
                    // --- Affichage Simple ---
                    const players = participants
                        .map(p => getPlayerById(p.playerId))
                        .filter(Boolean) // Filtrer les joueurs supprimés
                        .sort((a,b) => a.lastName.localeCompare(b.lastName));
                        
                    participantsTableBody.innerHTML = players.map(player => `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 w-5"></td> <!-- Vide pour l'icône -->
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${player.lastName}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${player.firstName}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${player.license}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${player.club}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                <button data-participant-id="${participants.find(p => p.playerId === player.id).participantId}" class="btn-remove-participant text-red-600 hover:text-red-900">Retirer</button>
                            </td>
                        </tr>
                    `).join('');
                
                } else {
                    // --- Affichage Double / Mixte ---
                    participants.sort((a, b) => { // Trier par nom du joueur 1
                        const p1a = getPlayerById(a.player1Id);
                        const p1b = getPlayerById(b.player1Id);
                        if (!p1a || !p1b) return 0;
                        return p1a.lastName.localeCompare(p1b.lastName);
                    });
                    
                    participants.forEach(pair => {
                        const player1 = getPlayerById(pair.player1Id);
                        const player2 = getPlayerById(pair.player2Id);
                        
                        // Si un des joueurs a été supprimé, ne pas afficher la paire
                        if (!player1 || !player2) return; 
                        
                        // Ligne Joueur 1
                        participantsTableBody.innerHTML += `
                            <tr class="pair-row hover:bg-gray-50">
                                <td class="px-6 py-4 w-5 text-gray-400 pair-indicator" rowspan="2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-people" viewBox="0 0 16 16">
                                      <path d="M15 14s1 0 1-1-1-4-5-4-5 3-5 4 1 1 1 1zm-7.978-1L7 12.996c.001-.264.167-1.03.76-1.72C8.312 10.629 9.282 10 11 10c1.717 0 2.687.63 3.24 1.276.593.69.758 1.457.76 1.72l-.006.004zM11 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4m3-2a3 3 0 1 1-6 0 3 3 0 0 1 6 0M6.936 9.28a5.88 5.88 0 0 0-1.23-.247A7.35 7.35 0 0 0 5 9c-4 0-5 3-5 4 0 1 1 1 1 1h4.216A2.24 2.24 0 0 1 5 13c0-1.01.377-2.042 1.09-2.904.243-.294.526-.569.846-.816M4.92 10A5.49 5.49 0 0 0 4 13H1s1 0 1-1-1-4-4-4 3.002 4 3.92 4zM4 5a2 2 0 1 0 0-4 2 2 0 0 0 0 4m-2 2a3 3 0 1 1 6 0 3 3 0 0 1-6 0"/>
                                    </svg>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${player1.lastName}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${player1.firstName}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${player1.license}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${player1.club}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2" rowspan="2">
                                    <button data-participant-id="${pair.participantId}" class="btn-remove-participant text-red-600 hover:text-red-900">Retirer</button>
                                </td>
                            </tr>
                        `;
                        // Ligne Joueur 2
                        participantsTableBody.innerHTML += `
                            <tr class="pair-row hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${player2.lastName}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${player2.firstName}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${player2.license}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${player2.club}</td>
                            </tr>
                        `;
                    });
                }
            }

            // Rendu dropdowns (après que le tableau soit mis à jour)
            populateParticipantDropdowns();
            
            // Activer/Désactiver le bouton d'ajout
            const addParticipantBtn = document.getElementById('show-add-participant-modal-btn');
            addParticipantBtn.disabled = getAvailablePlayersForTournament().length < (currentTournament.type === 'simple' ? 1 : 2);
        }
        
        // Renvoie la liste des joueurs NON ENCORE INSCRITS dans ce tournoi
        function getAvailablePlayersForTournament() {
            if (!currentTournament) return [];
            
            const registeredPlayerIds = new Set();
            currentTournament.participants.forEach(p => {
                if (p.playerId) {
                    registeredPlayerIds.add(p.playerId); // Simple
                }
                if (p.player1Id) {
                    registeredPlayerIds.add(p.player1Id); // Paire
                }
                if (p.player2Id) {
                    registeredPlayerIds.add(p.player2Id); // Paire
                }
            });
            
            return allPlayers.filter(p => !registeredPlayerIds.has(p.id));
        }
        
        // Remplit les listes déroulantes/checkboxes des modales d'ajout
        function populateParticipantDropdowns() {
            if (!currentTournament) return;
            
            const availablePlayers = getAvailablePlayersForTournament();
            availablePlayers.sort((a,b) => a.lastName.localeCompare(b.lastName)); // Trier la liste

            if (currentTournament.type === 'simple') {
                // NOUVEAU: Modale Simple (Cases à cocher)
                if (availablePlayers.length === 0) {
                    participantCheckboxList.innerHTML = `<p class="text-sm text-gray-500 p-4 text-center">Tous les joueurs sont inscrits.</p>`;
                    addParticipantSimpleSubmitBtn.disabled = true;
                } else {
                    participantCheckboxList.innerHTML = availablePlayers.map(p => `
                        <label class="flex items-center text-sm text-gray-700 p-2 rounded hover:bg-gray-100">
                            <input type="checkbox" data-id="${p.id}" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mr-3">
                            ${p.lastName} ${p.firstName} <span class="text-gray-500 ml-2">(${p.club})</span>
                        </label>
                    `).join('');
                    addParticipantSimpleSubmitBtn.disabled = false;
                }
                document.getElementById('modal-participant-simple-tournament-name').textContent = currentTournament.name;

            } else {
                // Modale Paire (Dropdowns)
                const optionsHtml = availablePlayers
                    .map(p => `<option value="${p.id}">${p.lastName} ${p.firstName} (${p.club})</option>`).join('');
                    
                pairPlayer1Select.innerHTML = `<option value="" disabled selected>Sélectionner le joueur 1...</option>` + optionsHtml;
                pairPlayer2Select.innerHTML = `<option value="" disabled selected>Sélectionner le joueur 2...</option>` + optionsHtml;
                document.getElementById('modal-participant-pair-tournament-name').textContent = currentTournament.name;
                
                // Cacher le message de succès
                pairAddedSuccess.classList.add('hidden');
            }
        }


        // --- Navigation et Modales ---
        function showView(viewId) {
            Object.values(views).forEach(view => view.classList.add('hidden'));
            if (views[viewId]) {
                views[viewId].classList.remove('hidden');
            }
            activeView = viewId;

            // Gérer la classe "active" des boutons de navigation
            navButtons.players.classList.toggle('bg-blue-600', viewId === 'players');
            navButtons.tournaments.classList.toggle('bg-blue-600', viewId === 'tournaments');
            
            // Gérer la classe "active" des tournois de la sidebar
            document.querySelectorAll('.btn-sidebar-tournament').forEach(btn => {
                btn.classList.toggle('bg-gray-700', currentTournament && btn.dataset.id === currentTournament.id);
            });
        }

        function showModal(modalId) {
            if (modals[modalId]) {
                modals[modalId].classList.remove('hidden');
            }
        }
        function hideModal(modalId) {
            if (modals[modalId]) {
                modals[modalId].classList.add('hidden');
            }
        }
        
        function hideAllModals() {
            Object.values(modals).forEach(modal => modal.classList.add('hidden'));
        }

        // --- Gestionnaires d'événements ---
        function setupEventListeners() {
            // Navigation principale
            navButtons.players.addEventListener('click', () => {
                currentTournament = null; // Désélectionner le tournoi
                showView('players');
            });
            navButtons.tournaments.addEventListener('click', () => {
                currentTournament = null; // Désélectionner le tournoi
                showView('tournaments');
            });

            // Tri des joueurs
            sortPlayersSelect.addEventListener('change', (e) => {
                currentSortMode = e.target.value;
                renderPlayers();
            });

            // Recherche de joueurs
            searchPlayersInput.addEventListener('input', (e) => {
                currentSearchTerm = e.target.value.toLowerCase();
                renderPlayers();
            });

            // Boutons "Ouvrir Modale"
            document.getElementById('show-add-player-modal-btn').addEventListener('click', () => showModal('addPlayer'));
            document.getElementById('show-add-tournament-modal-btn').addEventListener('click', () => showModal('addTournament'));
            
            // Ouvre la BONNE modale (Simple ou Paire)
            document.getElementById('show-add-participant-modal-btn').addEventListener('click', () => {
                if (!currentTournament) return;
                
                // Pré-remplir les listes
                populateParticipantDropdowns();
                
                if (currentTournament.type === 'simple') {
                    // Réinitialiser les cases (au cas où)
                    participantCheckboxList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                    showModal('addParticipantSimple');
                } else {
                    pairPlayer1Select.value = "";
                    pairPlayer2Select.value = "";
                    pairWarning.classList.add('hidden');
                    pairAddedSuccess.classList.add('hidden');
                    document.getElementById('add-participant-pair-submit-btn').disabled = true;
                    showModal('addParticipantPair');
                }
            });
            
            // Validation de la modale Paire (pour éviter doublons)
            [pairPlayer1Select, pairPlayer2Select].forEach(select => {
                select.addEventListener('change', () => {
                    const p1 = pairPlayer1Select.value;
                    const p2 = pairPlayer2Select.value;
                    const isValid = p1 && p2 && p1 !== p2;
                    pairWarning.classList.toggle('hidden', !p1 || !p2 || p1 !== p2);
                    document.getElementById('add-participant-pair-submit-btn').disabled = !isValid;
                    pairAddedSuccess.classList.add('hidden'); // Cacher si on change
                });
            });

            // Boutons "Annuler" des modales
            document.querySelectorAll('.modal-cancel-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                   hideAllModals();
                });
            });
            // Clic sur l'overlay pour fermer
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        hideAllModals();
                    }
                });
            });

            // Soumission des formulaires
            document.getElementById('form-add-player').addEventListener('submit', handleAddNewPlayer);
            document.getElementById('form-edit-player').addEventListener('submit', handleEditPlayer);
            document.getElementById('form-add-tournament').addEventListener('submit', handleAddNewTournament);
            document.getElementById('form-add-participant-simple').addEventListener('submit', handleAddParticipantSimple);
            document.getElementById('form-add-participant-pair').addEventListener('submit', handleAddParticipantPair);


            // Clics sur les listes (Event Delegation)
            playersTableBody.addEventListener('click', e => {
                const target = e.target;
                const id = target.dataset.id;
                
                if (target.classList.contains('btn-delete-player')) {
                    if (confirm("Êtes-vous sûr de vouloir supprimer ce joueur ? Il sera retiré de tous les tableaux.")) {
                        handleDeletePlayer(id);
                    }
                }
                if (target.classList.contains('btn-edit-player')) {
                    openEditPlayerModal(id);
                }
            });

            tournamentsTableBody.addEventListener('click', e => {
                const id = e.target.dataset.id;
                if (e.target.classList.contains('btn-delete-tournament')) {
                    if (confirm("Êtes-vous sûr de vouloir supprimer ce tableau ?")) {
                        handleDeleteTournament(id);
                    }
                }
                if (e.target.classList.contains('btn-manage-tournament')) {
                    loadTournamentDetails(id);
                }
            });
            
            sidebarTournamentsList.addEventListener('click', e => {
                const btn = e.target.closest('.btn-sidebar-tournament');
                if (btn) {
                    loadTournamentDetails(btn.dataset.id);
                }
            });

            participantsTableBody.addEventListener('click', e => {
                const btn = e.target.closest('.btn-remove-participant');
                if (btn) {
                    const participantId = btn.dataset.participantId;
                    handleRemoveParticipant(participantId);
                }
            });
        }
        
        // --- Actions (Joueurs) ---
        function handleAddNewPlayer(event) {
            event.preventDefault();
            const newPlayer = {
                id: crypto.randomUUID(),
                lastName: document.getElementById('new-player-lastname').value,
                firstName: document.getElementById('new-player-firstname').value,
                registrationDate: document.getElementById('new-player-regdate').value,
                license: document.getElementById('new-player-license').value,
                club: document.getElementById('new-player-club').value,
                wishesSimple: document.getElementById('new-player-wishes-simple').checked,
                wishesDouble: document.getElementById('new-player-wishes-double').checked,
                wishesMixte: document.getElementById('new-player-wishes-mixte').checked,
            };
            
            if (!newPlayer.firstName || !newPlayer.lastName || !newPlayer.license || !newPlayer.club || !newPlayer.registrationDate) {
                console.error("Données incomplètes pour ajouter un joueur.");
                return;
            }
            
            allPlayers.push(newPlayer);
            renderPlayers(); // Rafraîchir la liste
            
            event.target.reset(); // Réinitialiser le formulaire
            hideModal('addPlayer');
        }
        
        function openEditPlayerModal(playerId) {
            const player = allPlayers.find(p => p.id === playerId);
            if (!player) return;
            
            document.getElementById('edit-player-id').value = player.id;
            document.getElementById('edit-player-lastname').value = player.lastName;
            document.getElementById('edit-player-firstname').value = player.firstName;
            document.getElementById('edit-player-regdate').value = player.registrationDate;
            document.getElementById('edit-player-license').value = player.license;
            document.getElementById('edit-player-club').value = player.club;
            document.getElementById('edit-player-wishes-simple').checked = player.wishesSimple || false;
            document.getElementById('edit-player-wishes-double').checked = player.wishesDouble || false;
            document.getElementById('edit-player-wishes-mixte').checked = player.wishesMixte || false;
            
            showModal('editPlayer');
        }
        
        function handleEditPlayer(event) {
            event.preventDefault();
            const playerId = document.getElementById('edit-player-id').value;
            
            const playerIndex = allPlayers.findIndex(p => p.id === playerId);
            if (playerIndex === -1) {
                console.error("Impossible de modifier : joueur non trouvé.");
                hideModal('editPlayer');
                return;
            }
            
            allPlayers[playerIndex] = {
                id: playerId,
                lastName: document.getElementById('edit-player-lastname').value,
                firstName: document.getElementById('edit-player-firstname').value,
                registrationDate: document.getElementById('edit-player-regdate').value,
                license: document.getElementById('edit-player-license').value,
                club: document.getElementById('edit-player-club').value,
                wishesSimple: document.getElementById('edit-player-wishes-simple').checked,
                wishesDouble: document.getElementById('edit-player-wishes-double').checked,
                wishesMixte: document.getElementById('edit-player-wishes-mixte').checked,
            };
            
            renderPlayers();
            
            if (activeView === 'tournament-detail') {
                renderTournamentDetail(); // Rafraîchir si les noms ont changé
            }
            
            event.target.reset();
            hideModal('editPlayer');
        }

        function handleDeletePlayer(playerId) {
            // 1. Retirer de la liste principale
            allPlayers = allPlayers.filter(p => p.id !== playerId);
            
            // 2. Retirer ce joueur de tous les tournois (Simple et Paires)
            allTournaments.forEach(tournament => {
                tournament.participants = tournament.participants.filter(p => {
                    if (p.playerId) return p.playerId !== playerId; // Simple
                    if (p.player1Id) return p.player1Id !== playerId && p.player2Id !== playerId; // Paire
                    return true;
                });
            });
            
            renderPlayers();
            
            if (activeView === 'tournament-detail') {
                renderTournamentDetail();
            }
            renderTournamentsList(); // Mettre à jour les compteurs
            renderSidebarTournaments(); // Mettre à jour la sidebar
        }

        // --- Actions (Tournois) ---
        function handleAddNewTournament(event) {
            event.preventDefault();
            const name = document.getElementById('new-tournament-name').value;
            const type = document.getElementById('new-tournament-type').value;

            if (!name) return;
            
            const newTournament = {
                id: crypto.randomUUID(),
                name,
                type,
                participants: [] // Structure: { participantId, ... }
            };
            allTournaments.push(newTournament);
            allTournaments.sort((a, b) => a.name.localeCompare(b.name));
            
            renderTournamentsList();
            renderSidebarTournaments();
            
            event.target.reset();
            hideModal('addTournament');
        }

        function handleDeleteTournament(tournamentId) {
            allTournaments = allTournaments.filter(t => t.id !== tournamentId);
            
            renderTournamentsList();
            renderSidebarTournaments();
            
            if (currentTournament && currentTournament.id === tournamentId) {
                currentTournament = null;
                showView('tournaments');
            }
        }

        // --- Actions (Participants) ---
        function loadTournamentDetails(tournamentId) {
            currentTournament = allTournaments.find(t => t.id === tournamentId);
            if (currentTournament) {
                renderTournamentDetail();
                showView('tournamentDetail');
            }
        }

        // Gère l'ajout de joueurs SIMPLES (via cases à cocher)
        function handleAddParticipantSimple(event) {
            event.preventDefault();
            if (!currentTournament) return;

            const checkboxes = participantCheckboxList.querySelectorAll('input[type="checkbox"]:checked');
            if (checkboxes.length === 0) return;
            
            checkboxes.forEach(cb => {
                const newParticipant = {
                    participantId: crypto.randomUUID(),
                    playerId: cb.dataset.id
                };
                currentTournament.participants.push(newParticipant);
            });
            
            renderTournamentDetail();
            renderTournamentsList(); // Mettre à jour les compteurs
            
            // On ne ferme pas la modale, on rafraîchit juste la liste
            populateParticipantDropdowns();
        }
        
        // Gère l'ajout d'une PAIRE (et garde la modale ouverte)
        function handleAddParticipantPair(event) {
            event.preventDefault();
            const player1Id = pairPlayer1Select.value;
            const player2Id = pairPlayer2Select.value;
            
            if (!currentTournament || !player1Id || !player2Id || player1Id === player2Id) return;
            
            const newPair = {
                participantId: crypto.randomUUID(),
                player1Id: player1Id,
                player2Id: player2Id
            };
            
            currentTournament.participants.push(newPair);
            
            renderTournamentDetail();
            renderTournamentsList();
            
            // Réinitialiser le formulaire pour ajout suivant
            event.target.reset();
            
            // Mettre à jour les listes déroulantes
            populateParticipantDropdowns();
            
            // Afficher un succès temporaire
            pairAddedSuccess.classList.remove('hidden');
            setTimeout(() => {
                pairAddedSuccess.classList.add('hidden');
            }, 2000);
            
            // Ne pas fermer la modale
            // hideModal('addParticipantPair');
        }

        function handleRemoveParticipant(participantIdToRemove) {
            if (!currentTournament) return;
            
            currentTournament.participants = currentTournament.participants.filter(p => p.participantId !== participantIdToRemove);
            
            renderTournamentDetail();
            renderTournamentsList();
        }

    </script>

</body>
</html>


